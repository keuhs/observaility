# ëª¨ë°”ì¼ ê²Œì„ ì„œë¹„ìŠ¤ SLI/SLO ì •ì˜
# ê²Œì„ ì‚¬ìš©ì ê²½í—˜ì„ ëŒ€í‘œí•˜ëŠ” í•µì‹¬ ì§€í‘œì™€ ëª©í‘œ

apiVersion: sre.observaility.com/v1
kind: ServiceLevelObjective
metadata:
  name: mobile-game-service
  namespace: production
  labels:
    service: mobile-game
    team: game-sre
    environment: production
spec:
  description: "ëª¨ë°”ì¼ ê²Œì„ ì„œë¹„ìŠ¤ í•µì‹¬ ì‹ ë¢°ì„± ëª©í‘œ"

  # 1. ê²Œì„ ì„œë²„ ê°€ìš©ì„± (í•µì‹¬ SLI)
  slis:
    - name: game_server_availability
      description: "ê²Œì„ ì„œë²„ ì‘ë‹µ ì„±ê³µë¥ "
      sli:
        numerator: |
          sum(rate(game_requests_total{
            service="game-server",
            status_code!~"5..|4.."
          }[5m]))
        denominator: |
          sum(rate(game_requests_total{
            service="game-server"
          }[5m]))
        unit: "percentage"
      slo:
        target: 99.9
        window: 30d
        description: "ì›”ê°„ 99.9% ê°€ìš©ì„± ëª©í‘œ"
      alerting:
        burn_rates:
          - window: 1h
            factor: 14.4  # ë¹ ë¥¸ ì†Œì§„ (1ì‹œê°„)
            severity: critical
          - window: 6h
            factor: 6     # ëŠë¦° ì†Œì§„ (6ì‹œê°„)
            severity: warning

    # 2. ê²Œì„ ì•¡ì…˜ ì‘ë‹µ ì§€ì—°ì‹œê°„
    - name: game_action_latency
      description: "ê²Œì„ ì•¡ì…˜ ì‘ë‹µ ì†ë„ (p95)"
      sli:
        numerator: |
          histogram_quantile(0.95,
            sum(rate(game_action_duration_seconds_bucket{
              service="game-server"
            }[5m])) by (le)
          )
        denominator: "1"
        unit: "seconds"
      slo:
        target: 0.5
        window: 30d
        description: "p95 ì§€ì—°ì‹œê°„ 500ms ì´í•˜"
      alerting:
        thresholds:
          - threshold: 0.8
            severity: warning
          - threshold: 1.0
            severity: critical

    # 3. ê²Œì„ í”Œë ˆì´ ì˜¤ë¥˜ìœ¨
    - name: game_play_error_rate
      description: "ê²Œì„ í”Œë ˆì´ ì¤‘ ì˜¤ë¥˜ ë°œìƒë¥ "
      sli:
        numerator: |
          sum(rate(game_errors_total{
            service="game-server",
            error_type="gameplay"
          }[5m]))
        denominator: |
          sum(rate(game_requests_total{
            service="game-server"
          }[5m]))
        unit: "percentage"
      slo:
        target: 0.1
        window: 30d
        description: "ê²Œì„ í”Œë ˆì´ ì˜¤ë¥˜ìœ¨ 0.1% ì´í•˜"
      alerting:
        burn_rates:
          - window: 1h
            factor: 14.4
            severity: critical

    # 4. ë™ì‹œ ì ‘ì†ì ìˆ˜
    - name: concurrent_players
      description: "ë™ì‹œ ê²Œì„ ì„¸ì…˜ ìˆ˜"
      sli:
        numerator: |
          max_over_time(game_sessions_active{
            service="game-server"
          }[5m])
        denominator: "1"
        unit: "count"
      slo:
        target: 10000
        window: 30d
        description: "ìµœì†Œ 10,000ëª… ë™ì‹œ ì ‘ì† ì§€ì›"
      alerting:
        thresholds:
          - threshold: 8000
            severity: warning
          - threshold: 5000
            severity: critical

    # 5. ê²Œì„ ë§¤ì¹­ ì„±ê³µë¥ 
    - name: game_matching_success_rate
      description: "ê²Œì„ ë§¤ì¹­ ì‹œìŠ¤í…œ ì„±ê³µë¥ "
      sli:
        numerator: |
          sum(rate(game_matching_requests_total{
            service="matchmaking",
            status="success"
          }[5m]))
        denominator: |
          sum(rate(game_matching_requests_total{
            service="matchmaking"
          }[5m]))
        unit: "percentage"
      slo:
        target: 95.0
        window: 30d
        description: "ë§¤ì¹­ ì„±ê³µë¥  95% ì´ìƒ"
      alerting:
        burn_rates:
          - window: 1h
            factor: 14.4
            severity: critical

    # 6. ê²Œì„ ë°ì´í„° ì €ì¥ ì„±ê³µë¥ 
    - name: game_data_persistence_success_rate
      description: "ê²Œì„ ì§„í–‰ ë°ì´í„° ì €ì¥ ì„±ê³µë¥ "
      sli:
        numerator: |
          sum(rate(game_data_save_total{
            service="game-persistence",
            status="success"
          }[5m]))
        denominator: |
          sum(rate(game_data_save_total{
            service="game-persistence"
          }[5m]))
        unit: "percentage"
      slo:
        target: 99.99
        window: 30d
        description: "ë°ì´í„° ì €ì¥ ì„±ê³µë¥  99.99% ì´ìƒ"
      alerting:
        burn_rates:
          - window: 1h
            factor: 14.4
            severity: critical

  # ì—ëŸ¬ ë²„ì§“ ì •ì±…
  error_budget:
    target: 0.1  # 0.1% ì—ëŸ¬ ë²„ì§“ (99.9% ê°€ìš©ì„± ê¸°ì¤€)
    window: 30d
    policies:
      - name: deployment_freeze
        description: "ì—ëŸ¬ ë²„ì§“ ì†Œì§„ ì‹œ ë°°í¬ ì¼ì‹œì¤‘ì§€"
        threshold: 0.05  # 50% ì†Œì§„ ì‹œ
        action: "freeze_deployments"
      - name: rollback_trigger
        description: "ì—ëŸ¬ ë²„ì§“ 80% ì†Œì§„ ì‹œ ìë™ ë¡¤ë°±"
        threshold: 0.08  # 80% ì†Œì§„ ì‹œ
        action: "auto_rollback"

  # ê²Œì„ íŠ¹í™” ìš´ì˜ ì •ì±…
  game_specific:
    peak_hours:
      - start: "18:00"
        end: "22:00"
        timezone: "Asia/Seoul"
        description: "ì €ë… í”¼í¬ ì‹œê°„ëŒ€"
        slo_multiplier: 1.2  # í”¼í¬ ì‹œê°„ëŒ€ SLO ê°•í™”

    seasonal_events:
      - name: "holiday_events"
        description: "ê³µíœ´ì¼/ì´ë²¤íŠ¸ ê¸°ê°„"
        slo_multiplier: 1.1
        auto_scale: true

    maintenance_windows:
      - day: "tuesday"
        start: "02:00"
        end: "06:00"
        timezone: "Asia/Seoul"
        description: "í™”ìš”ì¼ ìƒˆë²½ ì •ê¸° ì ê²€"
        slo_exemption: true

  # ì•Œë¦¼ ë° ì—ìŠ¤ì»¬ë ˆì´ì…˜
  notifications:
    channels:
      - name: "game-sre-oncall"
        type: "slack"
        url: "https://hooks.slack.com/services/..."
        severity: ["critical", "warning"]

      - name: "game-ops-team"
        type: "pagerduty"
        escalation_policy: "game-sre-escalation"
        severity: ["critical"]

    templates:
      critical: |
        ğŸš¨ [CRITICAL] {{.Service}} SLO ìœ„ë°˜
        SLI: {{.SLIName}}
        í˜„ì¬ê°’: {{.CurrentValue}}
        ëª©í‘œê°’: {{.TargetValue}}
        ì—ëŸ¬ ë²„ì§“ ì†Œì§„ë¥ : {{.BudgetBurnRate}}%

        ì¦‰ì‹œ ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤!

      warning: |
        âš ï¸ [WARNING] {{.Service}} SLO ê²½ê³ 
        SLI: {{.SLIName}}
        í˜„ì¬ê°’: {{.CurrentValue}}
        ëª©í‘œê°’: {{.TargetValue}}
        ì—ëŸ¬ ë²„ì§“ ì†Œì§„ë¥ : {{.BudgetBurnRate}}%

  # ë¦¬ë·° ë° ê°œì„  ì‚¬ì´í´
  review_cycle:
    frequency: "monthly"
    stakeholders:
      - "game-sre-team"
      - "game-development-team"
      - "product-management"
      - "customer-support"

    metrics:
      - "slo_achievement_rate"
      - "error_budget_consumption"
      - "incident_frequency"
      - "user_satisfaction_score"
      - "revenue_impact"
