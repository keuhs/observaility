# 모바일 게임 서비스 SLO 기반 에러 버짓 소진 알람 규칙
# Prometheus AlertManager 규칙

groups:
  - name: slo-error-budget-burn-rates
    rules:
      # 1. 게임 서버 가용성 - 빠른 소진 (1시간)
      - alert: GameServerAvailabilitySLOErrorBudgetBurnFast
        expr: |
          (
            1 - (
              sum(rate(game_requests_total{service="game-server", status_code!~"5..|4.."}[1m]))
              /
              sum(rate(game_requests_total{service="game-server"}[1m]))
            )
          )
          > (1 - 0.999) * 14.4
        for: 5m
        labels:
          severity: critical
          service: game-server
          sli: game_server_availability
          team: game-sre
        annotations:
          summary: "게임 서버 가용성 SLO 빠른 에러 버짓 소진"
          description: |
            게임 서버 가용성이 1시간 내에 에러 버짓을 빠르게 소진하고 있습니다.
            현재 가용성: {{ $value | humanizePercentage }}
            목표 가용성: 99.9%
            에러 버짓 소진률: {{ (1 - $value) * 100 | humanizePercentage }}
          runbook_url: "https://runbooks.game-sre.com/game-server-availability"
          dashboard_url: "https://grafana.game-sre.com/d/game-service-overview"

      # 2. 게임 서버 가용성 - 느린 소진 (6시간)
      - alert: GameServerAvailabilitySLOErrorBudgetBurnSlow
        expr: |
          (
            1 - (
              sum(rate(game_requests_total{service="game-server", status_code!~"5..|4.."}[5m]))
              /
              sum(rate(game_requests_total{service="game-server"}[5m]))
            )
          )
          > (1 - 0.999) * 6
        for: 30m
        labels:
          severity: warning
          service: game-server
          sli: game_server_availability
          team: game-sre
        annotations:
          summary: "게임 서버 가용성 SLO 느린 에러 버짓 소진"
          description: |
            게임 서버 가용성이 6시간 내에 에러 버짓을 소진하고 있습니다.
            현재 가용성: {{ $value | humanizePercentage }}
            목표 가용성: 99.9%
            에러 버짓 소진률: {{ (1 - $value) * 100 | humanizePercentage }}

      # 3. 게임 액션 지연시간 임계치
      - alert: GameActionLatencyHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(game_action_duration_seconds_bucket{service="game-server"}[5m])) by (le)
          ) > 0.8
        for: 10m
        labels:
          severity: warning
          service: game-server
          sli: game_action_latency
          team: game-sre
        annotations:
          summary: "게임 액션 지연시간 경고"
          description: |
            게임 액션 응답 지연시간이 경고 임계치를 초과했습니다.
            현재 p95 지연시간: {{ $value }}초
            경고 임계치: 0.8초
            목표: 0.5초

      - alert: GameActionLatencyCritical
        expr: |
          histogram_quantile(0.95,
            sum(rate(game_action_duration_seconds_bucket{service="game-server"}[5m])) by (le)
          ) > 1.0
        for: 5m
        labels:
          severity: critical
          service: game-server
          sli: game_action_latency
          team: game-sre
        annotations:
          summary: "게임 액션 지연시간 위험"
          description: |
            게임 액션 응답 지연시간이 위험 임계치를 초과했습니다.
            현재 p95 지연시간: {{ $value }}초
            위험 임계치: 1.0초
            목표: 0.5초

      # 4. 게임 플레이 오류율 - 빠른 소진
      - alert: GamePlayErrorRateSLOErrorBudgetBurnFast
        expr: |
          (
            sum(rate(game_errors_total{service="game-server", error_type="gameplay"}[1m]))
            /
            sum(rate(game_requests_total{service="game-server"}[1m]))
          )
          > 0.001 * 14.4
        for: 5m
        labels:
          severity: critical
          service: game-server
          sli: game_play_error_rate
          team: game-sre
        annotations:
          summary: "게임 플레이 오류율 SLO 빠른 에러 버짓 소진"
          description: |
            게임 플레이 오류율이 1시간 내에 에러 버짓을 빠르게 소진하고 있습니다.
            현재 오류율: {{ $value | humanizePercentage }}
            목표 오류율: 0.1%
            에러 버짓 소진률: {{ ($value / 0.001) * 100 | humanizePercentage }}

      # 5. 동시 접속자 수 임계치
      - alert: ConcurrentPlayersLow
        expr: |
          max_over_time(game_sessions_active{service="game-server"}[5m]) < 8000
        for: 15m
        labels:
          severity: warning
          service: game-server
          sli: concurrent_players
          team: game-sre
        annotations:
          summary: "동시 접속자 수 경고"
          description: |
            동시 게임 세션 수가 경고 임계치 이하로 떨어졌습니다.
            현재 동시 접속자: {{ $value }}
            경고 임계치: 8,000명
            목표: 10,000명

      - alert: ConcurrentPlayersCritical
        expr: |
          max_over_time(game_sessions_active{service="game-server"}[5m]) < 5000
        for: 10m
        labels:
          severity: critical
          service: game-server
          sli: concurrent_players
          team: game-sre
        annotations:
          summary: "동시 접속자 수 위험"
          description: |
            동시 게임 세션 수가 위험 임계치 이하로 떨어졌습니다.
            현재 동시 접속자: {{ $value }}
            위험 임계치: 5,000명
            목표: 10,000명

      # 6. 게임 매칭 성공률 - 빠른 소진
      - alert: GameMatchingSuccessRateSLOErrorBudgetBurnFast
        expr: |
          (
            1 - (
              sum(rate(game_matching_requests_total{service="matchmaking", status="success"}[1m]))
              /
              sum(rate(game_matching_requests_total{service="matchmaking"}[1m]))
            )
          )
          > (1 - 0.95) * 14.4
        for: 5m
        labels:
          severity: critical
          service: matchmaking
          sli: game_matching_success_rate
          team: game-sre
        annotations:
          summary: "게임 매칭 성공률 SLO 빠른 에러 버짓 소진"
          description: |
            게임 매칭 성공률이 1시간 내에 에러 버짓을 빠르게 소진하고 있습니다.
            현재 성공률: {{ $value | humanizePercentage }}
            목표 성공률: 95%
            에러 버짓 소진률: {{ (1 - $value) * 100 | humanizePercentage }}

      # 7. 게임 데이터 저장 성공률 - 빠른 소진
      - alert: GameDataPersistenceSuccessRateSLOErrorBudgetBurnFast
        expr: |
          (
            1 - (
              sum(rate(game_data_save_total{service="game-persistence", status="success"}[1m]))
              /
              sum(rate(game_data_save_total{service="game-persistence"}[1m]))
            )
          )
          > (1 - 0.9999) * 14.4
        for: 5m
        labels:
          severity: critical
          service: game-persistence
          sli: game_data_persistence_success_rate
          team: game-sre
        annotations:
          summary: "게임 데이터 저장 성공률 SLO 빠른 에러 버짓 소진"
          description: |
            게임 데이터 저장 성공률이 1시간 내에 에러 버짓을 빠르게 소진하고 있습니다.
            현재 성공률: {{ $value | humanizePercentage }}
            목표 성공률: 99.99%
            에러 버짓 소진률: {{ (1 - $value) * 100 | humanizePercentage }}

  # 에러 버짓 소진률 대시보드용 메트릭
  - name: slo-error-budget-metrics
    rules:
      # 게임 서버 가용성 에러 버짓 소진률
      - record: slo:error_budget_burn_rate:game_server_availability
        expr: |
          (
            1 - (
              sum(rate(game_requests_total{service="game-server", status_code!~"5..|4.."}[5m]))
              /
              sum(rate(game_requests_total{service="game-server"}[5m]))
            )
          )
          / (1 - 0.999)

      # 게임 플레이 오류율 에러 버짓 소진률
      - record: slo:error_budget_burn_rate:game_play_error_rate
        expr: |
          (
            sum(rate(game_errors_total{service="game-server", error_type="gameplay"}[5m]))
            /
            sum(rate(game_requests_total{service="game-server"}[5m]))
          )
          / 0.001

      # 게임 매칭 성공률 에러 버짓 소진률
      - record: slo:error_budget_burn_rate:game_matching_success_rate
        expr: |
          (
            1 - (
              sum(rate(game_matching_requests_total{service="matchmaking", status="success"}[5m]))
              /
              sum(rate(game_matching_requests_total{service="matchmaking"}[5m]))
            )
          )
          / (1 - 0.95)

      # 게임 데이터 저장 성공률 에러 버짓 소진률
      - record: slo:error_budget_burn_rate:game_data_persistence_success_rate
        expr: |
          (
            1 - (
              sum(rate(game_data_save_total{service="game-persistence", status="success"}[5m]))
              /
              sum(rate(game_data_save_total{service="game-persistence"}[5m]))
            )
          )
          / (1 - 0.9999)
