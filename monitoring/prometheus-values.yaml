# ëª¨ë°”ì¼ ê²Œì„ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ
# Prometheus + Grafana + AlertManager Helm values

prometheus:
  prometheusSpec:
    retention: 30d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 100Gi
          storageClassName: "fast-ssd"

    # ê²Œì„ ì„œë¹„ìŠ¤ íŠ¹í™” ì„¤ì •
    resources:
      requests:
        memory: 4Gi
        cpu: 2
      limits:
        memory: 8Gi
        cpu: 4

    # ê²Œì„ íŠ¸ë˜í”½ íŠ¹ì„±ì„ ê³ ë ¤í•œ ì„¤ì •
    scrapeInterval: 15s
    evaluationInterval: 15s

    # ê²Œì„ ì„œë¹„ìŠ¤ íƒ€ê²Ÿ ì„¤ì •
    additionalScrapeConfigs:
      - job_name: 'game-server'
        static_configs:
          - targets: ['game-server:8080']
        metrics_path: '/metrics'
        scrape_interval: 10s
        scrape_timeout: 5s
        honor_labels: true

      - job_name: 'matchmaking-service'
        static_configs:
          - targets: ['matchmaking:8080']
        metrics_path: '/metrics'
        scrape_interval: 10s

      - job_name: 'game-persistence'
        static_configs:
          - targets: ['game-persistence:8080']
        metrics_path: '/metrics'
        scrape_interval: 10s

      - job_name: 'game-client-metrics'
        static_configs:
          - targets: ['game-client-metrics:8080']
        metrics_path: '/metrics'
        scrape_interval: 30s

      - job_name: 'game-load-balancer'
        static_configs:
          - targets: ['game-lb:8080']
        metrics_path: '/metrics'
        scrape_interval: 10s

    # ê²Œì„ íŠ¹í™” ê·œì¹™ íŒŒì¼
    ruleSelector:
      matchLabels:
        app: prometheus
        component: rules
        game-service: "true"

    # ê²Œì„ ì„œë¹„ìŠ¤ ì•ŒëŒ ê·œì¹™
    additionalAlertManagerConfigs:
      - name: 'game-sre-slack'
        staticConfigs:
          - targets:
            - 'slack-webhook-url'
        routePrefix: '/api/v1/'
        timeoutSeconds: 10

alertmanager:
  alertmanagerSpec:
    retention: 120h
    storage:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

    # ê²Œì„ ì„œë¹„ìŠ¤ ì•Œë¦¼ ì„¤ì •
    config:
      global:
        slack_api_url: 'https://hooks.slack.com/services/...'
        resolve_timeout: 5m

      route:
        group_by: ['alertname', 'service', 'severity']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 1h
        receiver: 'game-sre-oncall'
        routes:
          - match:
              severity: critical
            receiver: 'game-sre-critical'
            continue: true
          - match:
              service: game-server
            receiver: 'game-sre-game-server'
          - match:
              service: matchmaking
            receiver: 'game-sre-matchmaking'

      receivers:
        - name: 'game-sre-oncall'
          slack_configs:
            - channel: '#game-sre-oncall'
              title: '{{ template "slack.title" . }}'
              text: '{{ template "slack.text" . }}'
              actions:
                - type: button
                  text: 'ëŒ€ì‹œë³´ë“œ ë³´ê¸°'
                  url: '{{ template "slack.dashboard_url" . }}'
                - type: button
                  text: 'ëŸ°ë¶ ë³´ê¸°'
                  url: '{{ template "slack.runbook_url" . }}'

        - name: 'game-sre-critical'
          pagerduty_configs:
            - routing_key: 'game-sre-critical'
              description: '{{ template "pagerduty.description" . }}'
              severity: '{{ if eq .GroupLabels.severity "critical" }}critical{{ else }}warning{{ end }}'
              client: 'Prometheus'
              client_url: '{{ template "pagerduty.clientURL" . }}'

        - name: 'game-sre-game-server'
          slack_configs:
            - channel: '#game-server-alerts'
              title: 'ğŸ® {{ template "slack.title" . }}'
              text: '{{ template "slack.text" . }}'

        - name: 'game-sre-matchmaking'
          slack_configs:
            - channel: '#matchmaking-alerts'
              title: 'ğŸ¯ {{ template "slack.title" . }}'
              text: '{{ template "slack.text" . }}'

grafana:
  adminPassword: "game-sre-admin-2024!"

  # ê²Œì„ ì„œë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ ì„¤ì •
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'game-service'
          orgId: 1
          folder: 'Game Service'
          type: file
          disableDelete: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/game-service

  # ê²Œì„ ì„œë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ ìë™ ë¡œë“œ
  dashboards:
    game-service:
      game-service-overview:
        json: |
          {
            "dashboard": {
              "title": "Game Service Overview",
              "tags": ["game-service", "overview"],
              "timezone": "Asia/Seoul"
            }
          }
      game-server-slo:
        json: |
          {
            "dashboard": {
              "title": "Game Server SLO Dashboard",
              "tags": ["game-service", "slo", "game-server"],
              "timezone": "Asia/Seoul"
            }
          }
      matchmaking-slo:
        json: |
          {
            "dashboard": {
              "title": "Matchmaking SLO Dashboard",
              "tags": ["game-service", "slo", "matchmaking"],
              "timezone": "Asia/Seoul"
            }
          }

  # ê²Œì„ ì„œë¹„ìŠ¤ íŠ¹í™” ì„¤ì •
  grafana.ini:
    server:
      root_url: "https://grafana.game-sre.com"
    users:
      allow_sign_up: false
    auth:
      disable_login_form: false
    security:
      allow_embedding: true
    feature_toggles:
      enable: "publicDashboards,publicDashboardsEnabled"

  # ê²Œì„ ì„œë¹„ìŠ¤ ë°ì´í„° ì†ŒìŠ¤
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-operated:9090
          access: proxy
          isDefault: true
          editable: true
          jsonData:
            timeInterval: "15s"
            queryTimeout: "60s"
            httpMethod: "POST"

        - name: Loki
          type: loki
          url: http://loki:3100
          access: proxy
          editable: true
          jsonData:
            maxLines: 1000

        - name: Tempo
          type: tempo
          url: http://tempo:3200
          access: proxy
          editable: true
          jsonData:
            httpMethod: "GET"
            serviceMap:
              datasourceUid: "prometheus"

# ê²Œì„ ì„œë¹„ìŠ¤ íŠ¹í™” ì¶”ê°€ ì»´í¬ë„ŒíŠ¸
additionalComponents:
  # ê²Œì„ í´ë¼ì´ì–¸íŠ¸ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ê¸°
  gameClientMetrics:
    enabled: true
    image:
      repository: game-client-metrics
      tag: "latest"
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 200m

  # ê²Œì„ ë¡œë“œ ë°¸ëŸ°ì„œ ë©”íŠ¸ë¦­
  gameLoadBalancer:
    enabled: true
    image:
      repository: nginx/nginx-prometheus-exporter
      tag: "latest"
    resources:
      requests:
        memory: 128Mi
        cpu: 50m
      limits:
        memory: 256Mi
        cpu: 100m

# ê²Œì„ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ ì„¤ì •
gameServiceMonitoring:
  # ê²Œì„ í”¼í¬ ì‹œê°„ëŒ€ ì„¤ì •
  peakHours:
    - start: "18:00"
      end: "22:00"
      timezone: "Asia/Seoul"
      description: "ì €ë… í”¼í¬ ì‹œê°„ëŒ€"
      scaling:
        enabled: true
        minReplicas: 5
        maxReplicas: 20

  # ê²Œì„ ì´ë²¤íŠ¸ ê¸°ê°„ ì„¤ì •
  eventPeriods:
    - name: "holiday_events"
      description: "ê³µíœ´ì¼/ì´ë²¤íŠ¸ ê¸°ê°„"
      scaling:
        enabled: true
        minReplicas: 8
        maxReplicas: 25
      slo:
        multiplier: 1.1

  # ê²Œì„ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
  healthChecks:
    gameServer:
      path: "/health"
      port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1

    matchmaking:
      path: "/health"
      port: 8080
      initialDelaySeconds: 20
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1

    gamePersistence:
      path: "/health"
      port: 8080
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1

# ê²Œì„ ì„œë¹„ìŠ¤ ë¡œê¹… ì„¤ì •
logging:
  # ê²Œì„ ì´ë²¤íŠ¸ ë¡œê·¸ ìˆ˜ì§‘
  gameEvents:
    enabled: true
    retention: 90d
    sampling:
      rate: 0.1  # 10% ìƒ˜í”Œë§
      burst: 1000

  # ê²Œì„ í”Œë ˆì´ ë¡œê·¸
  gamePlay:
    enabled: true
    retention: 30d
    sampling:
      rate: 0.01  # 1% ìƒ˜í”Œë§
      burst: 100

  # ê²Œì„ ë§¤ì¹­ ë¡œê·¸
  matchmaking:
    enabled: true
    retention: 60d
    sampling:
      rate: 0.05  # 5% ìƒ˜í”Œë§
      burst: 500

# ê²Œì„ ì„œë¹„ìŠ¤ íŠ¸ë ˆì´ì‹± ì„¤ì •
tracing:
  # OpenTelemetry ì„¤ì •
  openTelemetry:
    enabled: true
    sampling:
      rate: 0.01  # 1% ìƒ˜í”Œë§
      burst: 1000

    # ê²Œì„ ì•¡ì…˜ë³„ íŠ¸ë ˆì´ì‹±
    gameActions:
      - name: "player_move"
        sampling_rate: 0.1
      - name: "game_match"
        sampling_rate: 0.05
      - name: "data_save"
        sampling_rate: 0.02
      - name: "error_occurred"
        sampling_rate: 1.0  # ì˜¤ë¥˜ëŠ” 100% íŠ¸ë ˆì´ì‹±
